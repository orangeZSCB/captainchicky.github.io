(window.webpackJsonppageos=window.webpackJsonppageos||[]).push([[2],{"8+I6":function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return a}));var s=i("YfMo");function n(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.PAGEOS=window.PageOS,this.hasStorage=!!this.PAGEOS.environment&&this.PAGEOS.environment.hasLocalStorage,this._REGION="us-east-1",this._API_VERSION="2013-12-02",this._creds=t,this.lastBatchSent=Date.now(),this.queue=[],this.batchTimer=null,this.BATCH_SIZE=10,this.BATCH_INTERVAL=5e3,this.hasStorage&&localStorage.getItem("PageOS_Kinesis")&&(this.queue=JSON.parse(localStorage.getItem("PageOS_Kinesis"))),this.init()}var t,i,a;return t=e,(i=[{key:"addToQueue",value:function(e){var t=e.records,i=e.streamName,s=e.sampling;t=Array.isArray(t)?t:[t];var n=[];t.forEach((function(e){!1!==s&&!1!==e.Sampling||n.push({Data:e.Data,PartitionKey:e.PartitionKey})})),n.length>0&&(this.queue.push({records:n,streamName:i}),this.hasStorage&&localStorage.setItem("PageOS_Kinesis",JSON.stringify(this.queue)),this.isBatchReady())}},{key:"clearTimer",value:function(){clearTimeout(this.batchTimer),this.batchTimer=null}},{key:"configureAwsKinesis",value:function(){try{window.AWS.config.credentials=new window.AWS.Credentials(this._creds.AccessKeyId,this._creds.SecretAccessKey,this._creds.SessionToken),window.AWS.config.region=this._REGION,this._awsKinesis=new window.AWS.Kinesis({apiVersion:this._API_VERSION}),s.c.info("SUCCESS Kinesis configured")}catch(e){return void s.c.warn("Disabled due to lack of credentials error ðŸ˜¤",e)}}},{key:"getQueueCount",value:function(){var e=0;return this.queue.forEach((function(t){e+=t.records.length})),e}},{key:"init",value:function(){var e=this,t=document.createElement("script");t.src="https://cdn.intergi.com/pageos/js/libs/aws-sdk-kinesis.min.js",document.head.appendChild(t),t.onload=function(){e.configureAwsKinesis()}}},{key:"isBatchReady",value:function(){var e=this;if(!this.queue.length)return!1;this.getQueueCount()>=this.BATCH_SIZE||Date.now()-this.lastBatchSent>this.BATCH_INTERVAL?(this.clearTimer(),this.sendToKinesis()):this.batchTimer||(this.batchTimer=setTimeout((function(){e.sendToKinesis()}),this.BATCH_INTERVAL))}},{key:"sendToKinesis",value:function(){var e=this;if(this._awsKinesis&&0!==this.queue.length){for(var t={};this.queue.length;){var i=this.queue.shift(),n=i.records,a=i.streamName;Array.isArray(t[a])?t[a]=t[a].concat(n):t[a]=n}this.hasStorage&&localStorage.setItem("PageOS_Kinesis",JSON.stringify(this.queue));var r=function(i){if(!t[i].length)return"continue";e._awsKinesis.putRecords({Records:t[i],StreamName:i},(function(e){e&&s.c.error("Kinesis Send Error: ".concat(e,"\n                        , pipeline: ").concat(i,", data: ").concat(t[i]))}))};for(var o in t)r(o);this.lastBatchSent=Date.now()}}}])&&n(t.prototype,i),a&&n(t,a),e}()}}]);